// üõí Tuotteet - Keskitetty tuotehallinta
// Kaikki tuotteet hallitaan admin-paneelista, ei esimerkkituotteita


// üõí Tuotteet - Keskitetty tuotehallinta (JSON tiedostosta)
let PRODUCTS_DATA = [];
let PRODUCTS_DATA_LOADED = false;

const CATEGORIES_DATA = [
  { id: 1, name: 'Elektroniikka', description: 'S√§hk√∂laitteet ja tarvikkeet' },
  { id: 2, name: '√Ñlykk√§√§t laitteet', description: '√Ñlylaitteet ja IoT' },
  { id: 3, name: 'Kuulokkeet & Audio', description: '√Ñ√§nilaitteet ja kuulokkeet' },
  { id: 4, name: 'Kodin tavarat', description: 'Kotitaloustuotteet' }
];

// üéØ Optimoitu latausfunktio - ei API-kutsuja!
// Lataa tuotteet products.all.json tiedostosta (vain kerran per sessio)
async function loadProductsFromJSON() {
  if (PRODUCTS_DATA_LOADED) {
    return {
      products: PRODUCTS_DATA,
      categories: CATEGORIES_DATA,
      source: 'memory',
      timestamp: new Date().toISOString()
    };
  }
  
  try {
    // 1. Yrit√§ ensin localStorage (v√§litt√∂m√§t muutokset)
    const localData = localStorage.getItem('products.all.json');
    if (localData) {
      PRODUCTS_DATA = JSON.parse(localData);
      PRODUCTS_DATA_LOADED = true;
      console.log('üì¶ Tuotteet ladattu localStorage:sta:', PRODUCTS_DATA.length);
      return {
        products: PRODUCTS_DATA,
        categories: CATEGORIES_DATA,
        source: 'localStorage',
        timestamp: new Date().toISOString()
      };
    }
    
    // 2. Jos ei localStorage, lataa tiedostosta
    const resp = await fetch('/products.all.json');
    PRODUCTS_DATA = await resp.json();
    PRODUCTS_DATA_LOADED = true;
    console.log('üì¶ Tuotteet ladattu products.all.json:', PRODUCTS_DATA.length);
    return {
      products: PRODUCTS_DATA,
      categories: CATEGORIES_DATA,
      source: 'products.all.json',
      timestamp: new Date().toISOString()
    };
  } catch (e) {
    console.error('‚ùå Tuotteiden lataus ep√§onnistui:', e);
    PRODUCTS_DATA = [];
    return {
      products: [],
      categories: CATEGORIES_DATA,
      source: 'fallback',
      timestamp: new Date().toISOString()
    };
  }
}

// Helper function to convert category name to ID
function getCategoryIdByName(categoryName) {
  if(!categoryName) return 1;
  const key = categoryName.toString().trim().toLowerCase();
  const categoryMap = {
    'elektroniikka': 1,
    'elektroniikka.': 1,
    'vaatteet': 2, // map "vaatteet" to second slot (reuse √Ñlylaitteet id)
    '√§lylaitteet': 2,
    '√§lykk√§√§t laitteet': 2,
    'audio': 3,
    'kuulokkeet & audio': 3,
    'kuulokkeet': 3,
    'koti': 4,
    'kodin tavarat': 4,
    '√§lykodit': 4
  };
  return categoryMap[key] || 1;
}

// üîç Hakutoiminnot (client-side, nopea)
function searchProducts(query, category = null) {
  let filtered = PRODUCTS_DATA;
  
  if (category && category !== 'all') {
    filtered = filtered.filter(p => p.category == category);
  }
  
  if (query && query.trim() !== '') {
    const searchTerm = query.toLowerCase();
    filtered = filtered.filter(p => 
      p.name.toLowerCase().includes(searchTerm) ||
      p.description.toLowerCase().includes(searchTerm) ||
      p.features.some(f => f.toLowerCase().includes(searchTerm))
    );
  }
  
  return filtered;
}

// üìä Tuotteen haku ID:ll√§ (client-side)
function getProductById(id) {
  return PRODUCTS_DATA.find(p => p.id == id) || null;
}

// üí∞ Hintalaskennat (client-side)
function calculateCartTotal(cart) {
  return cart.reduce((total, item) => {
    const product = getProductById(item.productId);
    return total + (product ? product.price * item.quantity : 0);
  }, 0);
}

// üè∑Ô∏è Kategorian haku
function getCategoryById(id) {
  return CATEGORIES_DATA.find(c => c.id == id) || null;
}

// üìà Suositut tuotteet (rating + reviews)
function getPopularProducts(limit = 4) {
  return PRODUCTS_DATA
    .sort((a, b) => (b.rating * b.reviews) - (a.rating * a.reviews))
    .slice(0, limit);
}

// üí∏ Tarjoustuotteet (alennetut)
function getSaleProducts(limit = 4) {
  return PRODUCTS_DATA
    .filter(p => p.originalPrice > p.price)
    .sort((a, b) => ((b.originalPrice - b.price) / b.originalPrice) - ((a.originalPrice - a.price) / a.originalPrice))
    .slice(0, limit);
}

// üõ†Ô∏è ADMIN CRUD FUNKTIOT - KESKITETTY TUOTEHALLINTA
async function addProduct(productData) {
  await ensureProductsLoaded();
  const newProduct = {
    id: Date.now(),
    name: productData.name,
    price: parseFloat(productData.price),
    originalPrice: parseFloat(productData.price) * 1.2,
    image: productData.image || "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=400",
    category: getCategoryIdByName(productData.category),
    description: productData.description || '',
    features: productData.features || ['Admin-tuote'],
    stock: parseInt(productData.stock) || 0,
    rating: 4.5,
    reviews: 12,
    featured: productData.featured || false
  };
  PRODUCTS_DATA.push(newProduct);
  await saveProductsToJSON();
  notifyDataChange();
  return newProduct;
}

async function updateProduct(id, productData) {
  await ensureProductsLoaded();
  const index = PRODUCTS_DATA.findIndex(p => p.id == id);
  if (index === -1) return null;
  const updatedProduct = {
    ...PRODUCTS_DATA[index],
    name: productData.name,
    price: parseFloat(productData.price),
    originalPrice: parseFloat(productData.price) * 1.2,
    image: productData.image,
    category: parseInt(productData.category) || productData.category, // K√§yt√§ suoraan kategoria-ID:t√§
    description: productData.description,
    stock: parseInt(productData.stock) || 0,
    featured: productData.featured || false
  };
  PRODUCTS_DATA[index] = updatedProduct;
  await saveProductsToJSON();
  notifyDataChange();
  return updatedProduct;
}

async function deleteProduct(id) {
  await ensureProductsLoaded();
  const index = PRODUCTS_DATA.findIndex(p => p.id == id);
  if (index === -1) return false;
  const deletedProduct = PRODUCTS_DATA[index];
  PRODUCTS_DATA.splice(index, 1);
  await saveProductsToJSON();
  notifyDataChange();
  return true;
}
// Tallenna tuotteet products.all.json tiedostoon
async function saveProductsToJSON() {
  try {
    // 1. Tallenna localStorage:iin v√§litt√∂m√§sti (n√§kyy heti)
    localStorage.setItem('products.all.json', JSON.stringify(PRODUCTS_DATA));
    console.log('üíæ Tuotteet tallennettu localStorage:iin');
    
    // 2. Yrit√§ tallentaa oikeaan tiedostoon (dev-ymp√§rist√∂ss√§)
    try {
      const response = await fetch('/api/save-products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(PRODUCTS_DATA)
      });
      if (response.ok) {
        console.log('üíæ Tuotteet tallennettu tiedostoon!');
      } else {
        console.log('‚ö†Ô∏è Tiedostotallennus ep√§onnistui, k√§ytet√§√§n localStorage');
      }
    } catch (fileError) {
      console.log('‚ö†Ô∏è Ei API-yhteytt√§, k√§ytet√§√§n localStorage');
    }
    
    // 3. Pakota uudelleenlataus seuraavalla kerralla
    PRODUCTS_DATA_LOADED = false;
  } catch (e) {
    console.error('‚ùå Tuotteiden tallennus ep√§onnistui:', e);
  }
}

async function ensureProductsLoaded() {
  if (!PRODUCTS_DATA_LOADED) {
    await loadProductsFromJSON();
  }
}

// (Duplicate removed; unified implementation above)

// üì¢ Ilmoita muutoksista muille komponenteille
function notifyDataChange() {
  // Pakota datan uudelleenlataus
  PRODUCTS_DATA_LOADED = false;
  
  console.log('üîÑ notifyDataChange: P√§ivitet√§√§n kaikki n√§kym√§t');
  
  // P√§ivit√§ etusivu jos se on auki
  if (window.shopApp && typeof window.shopApp.refreshProducts === 'function') {
    console.log('üîÑ P√§ivitet√§√§n etusivu');
    window.shopApp.refreshProducts();
  }
  
  // P√§ivit√§ admin-paneeli jos se on auki - viive varmistaa ett√§ localStorage on p√§ivitetty
  setTimeout(() => {
    if (window.adminPanel && typeof window.adminPanel.displayProducts === 'function') {
      console.log('üîÑ P√§ivitet√§√§n admin-paneeli');
      window.adminPanel.loadProducts().then(() => {
        window.adminPanel.displayProducts();
      });
    }
  }, 100);
  
  // L√§het√§ custom event
  window.dispatchEvent(new CustomEvent('productsUpdated', {
    detail: { products: PRODUCTS_DATA, timestamp: new Date() }
  }));
}

// üîÑ Backward compatibility ShopApp:lle + ADMIN CRUD
window.PRODUCTS_JSON = {
  // Haku ja n√§ytt√∂
  loadProductsFromJSON,
  searchProducts,
  getProductById,
  calculateCartTotal,
  getCategoryById,
  getPopularProducts,
  getSaleProducts,
  
  // Admin CRUD funktiot
  addProduct,
  updateProduct,
  deleteProduct,
  getCategoryIdByName,
  notifyDataChange,
  
  // Data
  PRODUCTS_DATA,
  CATEGORIES_DATA,
  
  // Getterit live-datalle
  get products() { return PRODUCTS_DATA; },
  get categories() { return CATEGORIES_DATA; }
};

// üåç AliExpress tuotteiden haku backend-palvelun kautta
async function fetchFromAliExpress(productId) {
  try {
    console.log(`üîÑ Haetaan AliExpress tuote: ${productId}`);
    
    const response = await fetch(`http://localhost:3001/api/product/${productId}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const productData = await response.json();
    
    // Lis√§√§ tuote keskitettyyn j√§rjestelm√§√§n
    const addedProduct = addProduct(productData);
    
    console.log(`‚úÖ AliExpress tuote lis√§tty:`, addedProduct.name);
    return addedProduct;
    
  } catch (error) {
    console.error('‚ùå AliExpress haku ep√§onnistui:', error.message);
    throw error;
  }
}

// üõí Lis√§√§ useita AliExpress tuotteita kerralla
async function fetchMultipleFromAliExpress(productIds) {
  try {
    console.log(`üîÑ Haetaan ${productIds.length} tuotetta AliExpressist√§...`);
    
    const response = await fetch('http://localhost:3001/api/products/batch', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ productIds })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const { results, errors } = await response.json();
    
    // Lis√§√§ onnistuneet tuotteet keskitettyyn j√§rjestelm√§√§n
    const addedProducts = [];
    for (const productData of results) {
      try {
        const addedProduct = addProduct(productData);
        addedProducts.push(addedProduct);
      } catch (error) {
        console.warn(`‚ö†Ô∏è Tuotteen lis√§ys ep√§onnistui:`, error.message);
      }
    }
    
    console.log(`‚úÖ Lis√§tty ${addedProducts.length}/${productIds.length} tuotetta`);
    
    if (errors.length > 0) {
      console.warn(`‚ö†Ô∏è Virheit√§: ${errors.length}`, errors);
    }
    
    return { addedProducts, errors };
    
  } catch (error) {
    console.error('‚ùå Batch haku ep√§onnistui:', error.message);
    throw error;
  }
}

// üìä Tarkista backend yhteys
async function checkBackendConnection() {
  try {
    const response = await fetch('http://localhost:3001/api/status');
    const status = await response.json();
    console.log('üîó Backend status:', status);
    return status;
  } catch (error) {
    console.error('‚ùå Backend ei vastaa:', error.message);
    return null;
  }
}

console.log('‚úÖ Tuote-JSON ladattu:', PRODUCTS_DATA.length, 'tuotetta,', CATEGORIES_DATA.length, 'kategoriaa');