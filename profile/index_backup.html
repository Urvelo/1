<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K√§ytt√§j√§profiili - L√∂yt√∂kauppa</title>
  <link rel="stylesheet" href="../styles/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --secondary: #1d4ed8;
      --accent: #3b82f6;
      --success: #059669;
      --danger: #dc2626;
      --warning: #d97706;
      --dark: #111827;
      --darker: #1f2937;
      --gray: #374151;
      --gray-light: #4b5563;
      --text: #f9fafb;
      --text-muted: #9ca3af;
      --border: #6b7280;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: var(--dark);
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      padding: 2rem;
      border-radius: 15px;
      margin-bottom: 2rem;
      text-align: center;
    }
    
    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    
    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .nav-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    
    .nav-tab {
      background: var(--gray);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 1rem 2rem;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 150px;
      text-align: center;
    }
    
    .nav-tab:hover, .nav-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .tab-content {
      display: none;
      background: var(--gray);
      border-radius: 15px;
      padding: 2rem;
      border: 1px solid var(--border);
    }
    
    .tab-content.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--gray-light);
      color: var(--text);
      font-size: 1rem;
    }
    
    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: var(--dark);
    }
    
    .btn {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-right: 1rem;
      margin-bottom: 1rem;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #e55353);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--success), #45b39d);
    }
    
    .orders-grid {
      display: grid;
      gap: 1rem;
    }
    
    .order-card {
      background: var(--gray-light);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.5rem;
      transition: all 0.3s ease;
    }
    
    .order-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .order-id {
      font-weight: bold;
      color: var(--primary);
      font-size: 1.1rem;
    }
    
    .order-status {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .status-new {
      background: var(--success);
      color: white;
    }
    
    .status-processing {
      background: var(--warning);
      color: var(--dark);
    }
    
    .status-shipped {
      background: var(--primary);
      color: white;
    }
    
    .order-details {
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    
    .order-total {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--success);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: var(--gray-light);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.5rem;
      text-align: center;
    }
    
    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }
    
    .stat-label {
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary);
      text-decoration: none;
      margin-bottom: 2rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .back-link:hover {
      background: rgba(102, 126, 234, 0.1);
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .nav-tabs {
        flex-direction: column;
      }
      
      .nav-tab {
        min-width: auto;
      }
      
      .order-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="../" class="back-link">
      <i class="fas fa-arrow-left"></i>
      Takaisin kauppaan
    </a>
    
    <div class="header">
      <h1>üë§ K√§ytt√§j√§profiili</h1>
      <p id="welcomeMessage">Tervetuloa profiilisivullesi</p>
    </div>
    
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab('profile')">
        <i class="fas fa-user"></i> Profiilitiedot
      </button>
      <button class="nav-tab" onclick="showTab('orders')">
        <i class="fas fa-box"></i> Tilaushistoria
      </button>
      <button class="nav-tab" onclick="showTab('settings')">
        <i class="fas fa-cog"></i> Asetukset
      </button>
      <button class="nav-tab" onclick="showTab('stats')">
        <i class="fas fa-chart-bar"></i> Tilastot
      </button>
    </div>
    
    <!-- PROFIILITIEDOT -->
    <div id="profile" class="tab-content active">
      <h2>üìù Muokkaa profiilitietoja</h2>
      <form id="profileForm">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
          <div>
            <div class="form-group">
              <label>Nimi</label>
              <input type="text" id="profileName" required>
            </div>
            
            <div class="form-group">
              <label>S√§hk√∂posti</label>
              <input type="email" id="profileEmail" required>
            </div>
            
            <div class="form-group">
              <label>Puhelinnumero</label>
              <input type="tel" id="profilePhone">
            </div>
          </div>
          
          <div>
            <div class="form-group">
              <label>Osoite</label>
              <textarea id="profileAddress" rows="3"></textarea>
            </div>
            
            <div class="form-group">
              <label>Uusi salasana (j√§t√§ tyhj√§ksi jos et halua vaihtaa)</label>
              <input type="password" id="profilePassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
          </div>
        </div>
        
        <button type="submit" class="btn btn-success">
          <i class="fas fa-save"></i> Tallenna muutokset
        </button>
        
        <button type="button" class="btn" onclick="resetForm()">
          <i class="fas fa-undo"></i> Peruuta
        </button>
      </form>
    </div>
    
    <!-- TILAUSHISTORIA -->
    <div id="orders" class="tab-content">
      <h2>üì¶ Tilaushistoria</h2>
      <div id="ordersContainer" class="orders-grid">
        <!-- Tilaukset ladataan t√§nne -->
      </div>
    </div>
    
    <!-- ASETUKSET -->
    <div id="settings" class="tab-content">
      <h2>‚öôÔ∏è Tilin asetukset</h2>
      
      <div style="margin-bottom: 2rem;">
        <h3>üîî Ilmoitusasetukset</h3>
        <label style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
          <input type="checkbox" id="emailNotifications" checked>
          S√§hk√∂posti-ilmoitukset tilauksista
        </label>
        
        <label style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
          <input type="checkbox" id="smsNotifications">
          SMS-ilmoitukset toimituksista
        </label>
        
        <label style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
          <input type="checkbox" id="marketingEmails">
          Markkinointiviestit ja tarjoukset
        </label>
      </div>
      
      <div style="margin-bottom: 2rem;">
        <h3>üíæ Tietojen hallinta</h3>
        <button class="btn" onclick="exportUserData()">
          <i class="fas fa-download"></i> Lataa omat tiedot
        </button>
        
        <button class="btn btn-danger" onclick="deleteAccount()">
          <i class="fas fa-trash"></i> Poista tili
        </button>
      </div>
      
      <button class="btn btn-success" onclick="saveSettings()">
        <i class="fas fa-save"></i> Tallenna asetukset
      </button>
    </div>
    
    <!-- TILASTOT -->
    <div id="stats" class="tab-content">
      <h2>üìä Ostoshistoria</h2>
      
      <div class="stats-grid" id="statsGrid">
        <!-- Tilastot ladataan t√§nne -->
      </div>
      
      <div style="margin-top: 2rem;">
        <h3>üìà Ostosk√§ytt√§ytyminen</h3>
        <div id="purchaseChart" style="background: var(--gray-light); padding: 2rem; border-radius: 10px; text-align: center; color: var(--text-muted);">
          <i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
          <p>Ostoshistorian kaavio tulossa pian...</p>
        </div>
      </div>
    </div>
  </div>
  
  <script src="database.js"></script>
  <script>
    class UserProfile {
      constructor() {
        this.currentUser = this.getCurrentUser();
        this.init();
      }
      
      getCurrentUser() {
        try {
          const userData = localStorage.getItem('currentUser');
          const isLoggedIn = localStorage.getItem('user_logged_in');
          
          console.log('üîç Profile.html tarkistaa kirjautuminen:', {
            userData: !!userData,
            isLoggedIn: isLoggedIn,
            userDataLength: userData?.length
          });
          
          if (isLoggedIn === 'true' && userData) {
            const user = JSON.parse(userData);
            console.log('‚úÖ K√§ytt√§j√§ l√∂ydetty profile.html:ss√§:', user.email);
            return user;
          }
          
          console.log('‚ùå K√§ytt√§j√§ ei kirjautunut profile.html:ss√§');
          return null;
        } catch (error) {
          console.error('‚ùå Virhe k√§ytt√§j√§tietojen lukemisessa:', error);
          return null;
        }
      }
      
      init() {
        if (!this.currentUser) {
          alert('‚ùå Sinun t√§ytyy kirjautua sis√§√§n!');
          window.location.href = '../auth/login.html';
          return;
        }
        
        this.loadUserData();
        this.loadOrders();
        this.loadStats();
        this.setupEventListeners();
      }
      
      loadUserData() {
        document.getElementById('welcomeMessage').textContent = 
          `Tervetuloa, ${this.currentUser.name}!`;
        
        document.getElementById('profileName').value = this.currentUser.name || '';
        document.getElementById('profileEmail').value = this.currentUser.email || '';
        document.getElementById('profilePhone').value = this.currentUser.phone || '';
        document.getElementById('profileAddress').value = this.currentUser.address || '';
      }
      
      loadOrders() {
        const container = document.getElementById('ordersContainer');
        const orders = db.getOrdersByUser(this.currentUser.email);
        
        if (orders.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
              <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
              <p style="font-size: 1.2rem;">Ei tilauksia viel√§</p>
              <p>Kun teet ensimm√§isen tilauksesi, se n√§kyy t√§√§ll√§</p>
              <a href="../" class="btn" style="margin-top: 1rem; text-decoration: none;">
                <i class="fas fa-shopping-cart"></i> Aloita ostokset
              </a>
            </div>
          `;
          return;
        }
        
        container.innerHTML = orders.map(order => {
          const statusClass = `status-${order.status || 'new'}`;
          const statusText = {
            'new': 'üÜï Uusi',
            'processing': '‚öôÔ∏è K√§sittelyss√§', 
            'shipped': 'üöö L√§hetetty'
          }[order.status || 'new'];
          
          return `
            <div class="order-card">
              <div class="order-header">
                <div class="order-id">#${order.id.toString().slice(-6)}</div>
                <div class="order-status ${statusClass}">${statusText}</div>
              </div>
              <div class="order-details">
                <div><strong>P√§iv√§m√§√§r√§:</strong> ${order.order_date}</div>
                <div><strong>Tuotteet:</strong> ${order.order_products}</div>
                <div><strong>Maksutapa:</strong> ${order.payment_method}</div>
              </div>
              <div class="order-total">Yhteens√§: ${order.order_total}</div>
            </div>
          `;
        }).join('');
      }
      
      loadStats() {
        const container = document.getElementById('statsGrid');
        const orders = db.getOrdersByUser(this.currentUser.email);
        
        const totalOrders = orders.length;
        const totalSpent = orders.reduce((sum, order) => {
          const amount = parseFloat(order.order_total?.replace('‚Ç¨', '') || 0);
          return sum + amount;
        }, 0);
        
        const averageOrder = totalOrders > 0 ? totalSpent / totalOrders : 0;
        
        const lastOrderDate = orders.length > 0 ? 
          new Date(Math.max(...orders.map(o => new Date(o.created || o.order_date)))).toLocaleDateString('fi-FI') : 
          'Ei viel√§';
        
        container.innerHTML = `
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-shopping-bag"></i>
            </div>
            <div class="stat-value">${totalOrders}</div>
            <div class="stat-label">Tilauksia yhteens√§</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-euro-sign"></i>
            </div>
            <div class="stat-value">${totalSpent.toFixed(2)}‚Ç¨</div>
            <div class="stat-label">Kulutettu yhteens√§</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-value">${averageOrder.toFixed(2)}‚Ç¨</div>
            <div class="stat-label">Keskim√§√§r√§inen tilaus</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stat-value" style="font-size: 1.2rem;">${lastOrderDate}</div>
            <div class="stat-label">Viimeisin tilaus</div>
          </div>
        `;
      }
      
      setupEventListeners() {
        document.getElementById('profileForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.saveProfile();
        });
      }
      
      saveProfile() {
        const updatedData = {
          name: document.getElementById('profileName').value,
          email: document.getElementById('profileEmail').value,
          phone: document.getElementById('profilePhone').value,
          address: document.getElementById('profileAddress').value
        };
        
        const newPassword = document.getElementById('profilePassword').value;
        if (newPassword) {
          updatedData.password = newPassword;
        }
        
        const updatedUser = db.updateUser(this.currentUser.id, updatedData);
        if (updatedUser) {
          localStorage.setItem('currentUser', JSON.stringify(updatedUser));
          this.currentUser = updatedUser;
          alert('‚úÖ Profiili p√§ivitetty onnistuneesti!');
          document.getElementById('profilePassword').value = '';
        } else {
          alert('‚ùå Profiilin p√§ivitys ep√§onnistui!');
        }
      }
    }
    
    // YLEISET FUNKTIOT
    function showTab(tabName) {
      // Piilota kaikki v√§lilehdet
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // N√§yt√§ valittu v√§lilehti
      document.getElementById(tabName).classList.add('active');
      
      // P√§ivit√§ napit
      document.querySelectorAll('.nav-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
    }
    
    function resetForm() {
      userProfile.loadUserData();
      document.getElementById('profilePassword').value = '';
    }
    
    function saveSettings() {
      const settings = {
        emailNotifications: document.getElementById('emailNotifications').checked,
        smsNotifications: document.getElementById('smsNotifications').checked,
        marketingEmails: document.getElementById('marketingEmails').checked
      };
      
      localStorage.setItem('user_settings', JSON.stringify(settings));
      alert('‚úÖ Asetukset tallennettu!');
    }
    
    function exportUserData() {
      const userData = {
        profile: userProfile.currentUser,
        orders: db.getOrdersByUser(userProfile.currentUser.email),
        settings: JSON.parse(localStorage.getItem('user_settings') || '{}'),
        exportDate: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(userData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `omat_tiedot_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      alert('üì• Omat tiedot ladattu!');
    }
    
    function deleteAccount() {
      if (confirm('‚ö†Ô∏è Haluatko varmasti poistaa tilisi?\n\nT√§m√§ toiminto ei ole palautettavissa!')) {
        if (confirm('üóëÔ∏è Viimeinen vahvistus: Kaikki tietosi poistetaan pysyv√§sti!')) {
          // Poista k√§ytt√§j√§ tietokannasta
          const users = db.getUsers();
          const filteredUsers = users.filter(u => u.id !== userProfile.currentUser.id);
          localStorage.setItem('registered_users', JSON.stringify(filteredUsers));
          
          // Poista session tiedot
          localStorage.removeItem('currentUser');
          localStorage.removeItem('user_logged_in');
          localStorage.removeItem('shopping_cart');
          localStorage.removeItem('user_settings');
          
          alert('üóëÔ∏è Tili poistettu. Olet kirjautunut ulos.');
          window.location.href = '../auth/login.html';
        }
      }
    }
    
    // Lataa asetukset
    document.addEventListener('DOMContentLoaded', function() {
      const settings = JSON.parse(localStorage.getItem('user_settings') || '{}');
      
      if (settings.emailNotifications !== undefined) {
        document.getElementById('emailNotifications').checked = settings.emailNotifications;
      }
      if (settings.smsNotifications !== undefined) {
        document.getElementById('smsNotifications').checked = settings.smsNotifications;
      }
      if (settings.marketingEmails !== undefined) {
        document.getElementById('marketingEmails').checked = settings.marketingEmails;
      }
    });
    
    // K√§ynnist√§ profiilisovellus
    const userProfile = new UserProfile();
  </script>
</body>
</html>